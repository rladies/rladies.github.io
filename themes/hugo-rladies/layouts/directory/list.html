
{{ define "main" }}
<!-- Selects -->
{{ $directory := .Pages }}
{{ $ints := slice }}
{{ $langs := slice }}
{{ $loc := slice }}
{{ $countries := slice }}

{{ range $directory }}
  {{ with .Params.interests }}
      {{ $ints = $ints | append  . }}
    {{ end }}
    
    {{ with .Params.languages }}
      {{ $langs = $langs | append  . }}
    {{ end }}
    
    {{ with .Params.location }}
      {{ $tmp := newScratch }}
      {{ with .country }}
        {{ $tmp.Set "loc" . }}
        {{ $countries = $countries | append  . }}
      {{ end }}
      
      {{ with .state }}
        {{ $tmp.Add "loc" ( . | printf ", %s") }}
      {{ end }}
      
      {{ with .city }}
        {{ $tmp.Add "loc" ( . | printf ", %s") }}
      {{ end }}
      
      {{ $loc = $loc | append  ($tmp.Get "loc") }}
  {{ end }}
{{ end }}
{{ $ints := $ints | uniq | sort }}
{{ $langs := $langs | uniq | sort }}
{{ $loc := $loc | uniq | sort }}
{{ $countries := $countries | uniq | sort }}
<!-- -->

  <div class="entry-content">
		{{ .Content }}
	</div>
  <div id="counters" class="row justify-content-center section topspace">
  	<div class="col-sm-5 col-md-4 text-center fadeInUp" data-wow-duration="500ms">
    	<div class="block">
    		<div class="icon-box">
    			<h3>{{ i18n "counter_entries" | markdownify }}</h3>
    			<i class="fa-solid fa-user"></i>
    			<p class="count" data-count="{{ $directory | len }}">0</p>
    		</div>
  		</div>
  	</div>
  </div>
  <div class="flex-container" id="directory-content">
    <div id="selection">
      
      <div class="input-group w-100">
        <select class="form-select" id="filter-interests" multiple data-group="interests">
          {{ range $ints }}
            <option value="{{. | urlize }}" >{{.}}</option>
          {{ end }}
        </select>
      </div>
              
      <div class="input-group">
        <select class="form-select" id="filter-languages" multiple data-group="languages">
          {{ range $langs }}
              <option value="{{. | urlize }}" >{{.}}</option>
          {{ end }}
        </select>
      </div>
                      
      <div class="input-group">
        <select class="form-select" id="filter-location" multiple data-group="location">
          {{ range $countries }}
            {{ $c := . }}
            <optgroup label="{{$c}}" class="{{$c}}">
            {{ range $loc }}
              {{ $l := findRE (printf "^%s" $c) . }}
              {{ if gt (len $l) 0 }}
                <option value="{{ . | htmlUnescape | urlize }}" >{{ replaceRE (printf "%s, " $c) "" . }}</option>
              {{ end }}
            {{ end }}
            </optgroup>
          {{ end }}
        </select>
      </div>
              
    </div>

    <div class="container expand-grid" id="directory-cards">
        <ul class="justify-content-center row row-xl-2 row-lg-3 row-md-4 row-sm-6 row-9 full-width shuffle-wrapper" id="directory-grid">
          {{ range $name := $directory | shuffle }}
              {{ partial "funcs/directory/card.html" (dict "data" . "name" $name "size" "large") }}
          {{ end }}
      </ul>
    </div>
  </div>
{{ end }}

{{ define  "footer" }}
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
  // Initialize Choices.js on all filter selects
  const interestsChoice = new Choices('#filter-interests', {
    removeItemButton: true,
    searchEnabled: true,
    placeholderValue: 'Select interests'
  });
  
  const languagesChoice = new Choices('#filter-languages', {
    removeItemButton: true,
    searchEnabled: true,
    placeholderValue: 'Select languages'
  });
  
  const locationChoice = new Choices('#filter-location', {
    removeItemButton: true,
    searchEnabled: true,
    placeholderValue: 'Select location'
  });

  // Initialize Shuffle.js
  const shuffleContainer = document.getElementById('directory-grid');
  const shuffleInstance = new Shuffle(shuffleContainer, {
    itemSelector: '.shuffle-item',
    buffer: 1,
    isCentered: true
  });

  // Apply filters function
  function applyFilters() {
    const interests = interestsChoice.getValue(true);
    const languages = languagesChoice.getValue(true);
    const locations = locationChoice.getValue(true);

    shuffleInstance.filter(item => {
      const itemInterests = JSON.parse(item.getAttribute('data-interests')) || [];
      const itemLanguages = JSON.parse(item.getAttribute('data-languages')) || [];
      const itemLocations = JSON.parse(item.getAttribute('data-location')) || [];

      return (
        (interests.length === 0 || interests.some(i => itemInterests.includes(i))) &&
        (languages.length === 0 || languages.some(l => itemLanguages.includes(l))) &&
        (locations.length === 0 || locations.some(loc => itemLocations.includes(loc)))
      );
    });
  }

  // Attach listeners
  document.querySelectorAll('[id^="filter-"]').forEach(select => {
    select.addEventListener('change', applyFilters);
  });
});
</script>
{{ end }}
