{{ define "main" }}
<!-- Selects -->
{{ $directory := .Pages }}
{{ $ints := slice }}
{{ $langs := slice }}
{{ $loc := slice }}
{{ $countries := slice }}

{{ range $directory }}
  {{ with .Params.interests }}
      {{ $ints = $ints | append  . }}
    {{ end }}
    
    {{ with .Params.languages }}
      {{ $langs = $langs | append  . }}
    {{ end }}
    
    {{ with .Params.location }}
      {{ $tmp := newScratch }}
      {{ with .country }}
        {{ $tmp.Set "loc" . }}
        {{ $countries = $countries | append  . }}
      {{ end }}
      
      {{ with .state }}
        {{ $tmp.Add "loc" ( . | printf ", %s") }}
      {{ end }}
      
      {{ with .city }}
        {{ $tmp.Add "loc" ( . | printf ", %s") }}
      {{ end }}
      
      {{ $loc = $loc | append  ($tmp.Get "loc") }}
  {{ end }}
{{ end }}
{{ $ints := $ints | uniq | sort }}
{{ $langs := $langs | uniq | sort }}
{{ $loc := $loc | uniq | sort }}
{{ $countries := $countries | uniq | sort }}

<!-- Hero Section -->
<div class="row mb-5">
  <div class="col-lg-10 mx-auto text-center">
    <div class="entry-content mb-4">
      {{ .Content }}
    </div>
  </div>
</div>

<!-- Stats Card -->
<div class="row mb-5">
  <div class="col-md-4 mx-auto">
    <div class="card border-0 shadow-sm text-center">
      <div class="card-body py-4">
        <i class="fa-solid fa-users fa-3x text-primary mb-3"></i>
        <h2 class="display-4 fw-bold text-primary mb-0">{{ $directory | len }}</h2>
        <p class="text-muted mb-0">{{ i18n "counter_entries" | markdownify }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="row g-3 mb-5">
  <div class="col-md-4">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center mb-2">
          <i class="fa-solid fa-tag text-primary me-2"></i>
          <label for="filter-interests" class="form-label mb-0 fw-semibold">Interests</label>
        </div>
        <select class="form-select" id="filter-interests" multiple data-group="interests">
          {{ range $ints }}
            <option value="{{. | urlize }}">{{.}}</option>
          {{ end }}
        </select>
      </div>
    </div>
  </div>
            
  <div class="col-md-4">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center mb-2">
          <i class="fa-solid fa-language text-primary me-2"></i>
          <label for="filter-languages" class="form-label mb-0 fw-semibold">Languages</label>
        </div>
        <select class="form-select" id="filter-languages" multiple data-group="languages">
          {{ range $langs }}
            <option value="{{. | urlize }}">{{.}}</option>
          {{ end }}
        </select>
      </div>
    </div>
  </div>
                    
  <div class="col-md-4">
    <div class="card h-100 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center mb-2">
          <i class="fa-solid fa-map-marker-alt text-primary me-2"></i>
          <label for="filter-location" class="form-label mb-0 fw-semibold">Location</label>
        </div>
        <select class="form-select" id="filter-location" multiple data-group="location">
          {{ range $countries }}
            {{ $c := . }}
            <optgroup label="{{$c}}" class="{{$c}}">
            {{ range $loc }}
              {{ $l := findRE (printf "^%s" $c) . }}
              {{ if gt (len $l) 0 }}
                <option value="{{ . | htmlUnescape | urlize }}">{{ replaceRE (printf "%s, " $c) "" . }}</option>
              {{ end }}
            {{ end }}
            </optgroup>
          {{ end }}
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Directory Cards -->
 <div class="breakout">
  <div class="container-wide p-0 px-3">
    <ul class="row row-cols-1 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-4 shuffle-wrapper w-100 list-unstyled" id="directory-grid">
      {{ range $name := $directory | shuffle }}
        {{ partial "funcs/directory/card.html" (dict "data" . "name" $name "size" "large") }}
      {{ end }}
    </ul>
  </div>
</div>

{{ end }}

{{ define "footer" }}
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Choices.js
    const interestsChoice = new Choices('#filter-interests', {
      removeItemButton: true,
      searchEnabled: true,
      placeholderValue: 'Filter by interests',
      searchPlaceholderValue: 'Search interests...'
    });
    
    const languagesChoice = new Choices('#filter-languages', {
      removeItemButton: true,
      searchEnabled: true,
      placeholderValue: 'Filter by languages',
      searchPlaceholderValue: 'Search languages...'
    });
    
    const locationChoice = new Choices('#filter-location', {
      removeItemButton: true,
      searchEnabled: true,
      placeholderValue: 'Filter by location',
      searchPlaceholderValue: 'Search location...'
    });

    // Initialize Shuffle.js
    const shuffleContainer = document.getElementById('directory-grid');
    const shuffleInstance = new Shuffle(shuffleContainer, {
      itemSelector: '.shuffle-item',
      buffer: 1,
      isCentered: true
    });

    // Apply filters
    function applyFilters() {
      const interests = interestsChoice.getValue(true);
      const languages = languagesChoice.getValue(true);
      const locations = locationChoice.getValue(true);

      shuffleInstance.filter(item => {
        const itemInterests = JSON.parse(item.getAttribute('data-interests')) || [];
        const itemLanguages = JSON.parse(item.getAttribute('data-languages')) || [];
        const itemLocations = JSON.parse(item.getAttribute('data-location')) || [];

        return (
          (interests.length === 0 || interests.some(i => itemInterests.includes(i))) &&
          (languages.length === 0 || languages.some(l => itemLanguages.includes(l))) &&
          (locations.length === 0 || locations.some(loc => itemLocations.includes(loc)))
        );
      });
    }

    // Attach listeners
    document.querySelectorAll('[id^="filter-"]').forEach(select => {
      select.addEventListener('change', applyFilters);
    });
  });
</script>
{{ end }}