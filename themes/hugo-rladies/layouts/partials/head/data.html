
<!-- 
Create an array that we can use to shuffle
the data entries on every build.
-->
{{ $.Scratch.Set "ment" (slice) }}
{{ range $name, $_ := $.Site.Data.mentoring }}
  {{ $.Scratch.Add "ment" $name }}
{{ end }}

{{ $.Scratch.Set "gt" (slice) }}
{{ range $name, $_ := $.Site.Data.global_team }}
  {{ $.Scratch.Add "gt" $name }}
{{ end }}

{{ $.Scratch.Set "rb" (slice) }}
{{ range $name, $_ := $.Site.Data.rblogs }}
  {{ $.Scratch.Add "rb" $name }}
{{ end }}


<!-- Chapter data -->
{{/* Fetch chapter data from meetup_archive JSON file */}}
{{ $chapters_meetup := slice}}
{{ $url := "https://raw.githubusercontent.com/rladies/meetup_archive/refs/heads/main/data/chapters.json" }}
{{ with try (resources.GetRemote $url) }}
  {{ with .Err }}
    {{ errorf "%s" . }}
  {{ else }}
    {{ $chapters_meetup = .Value | transform.Unmarshal }}
  {{ end }}
{{ else }}
  {{ errorf "Unable to get remote resource %q" $url }}
{{ end }}

<!-- range over all countries -->
{{ $countries := slice }}
{{ $.Scratch.Set "chpt_active" (slice) }}

{{ range $index, $chapter := $.Site.Data.chapters }}
  {{/* normalize local chapter value: if it's a slice (wrapped), take first element */}}
  {{ $chapterMap := $chapter }}
  {{/* Detect slice/array by inspecting the concrete type string (avoids using kindIs which may be unavailable) */}}
  {{ if in (printf "%T" $chapterMap) "[]interface" }}
    {{ $chapterMap = index $chapterMap 0 }}
  {{ end }}

  {{/* access status safely via index (works for map[string]interface{}) */}}
  {{ if eq (index $chapterMap "status") "active" }}

    {{/* find matching remote entry (where returns a slice) and pick first match if any */}}
    {{ $matches := where $chapters_meetup "urlname" (index $chapterMap "urlname") }}
    {{ if gt (len $matches) 0 }}
      {{ $mtp := index $matches 0 }}
      {{ $chapterMap = merge $chapterMap $mtp }}
    {{ end }}

    {{ $.Scratch.Add "chpt_active" $chapterMap }}
    {{ with (index $chapterMap "country") }}
      {{ $countries = $countries | append  . }}
    {{ end }}
  {{ end }}

{{ end }}
{{ $countries = $countries | uniq | sort }}
{{ $chapters_active := $.Scratch.Get "chpt_active" }}

<!-- range again to create count chapters per country -->
{{ .Scratch.Set "chpt_countries" (slice) }}
{{ range $countries }}
  {{ $count := where $chapters_active "country" . | len }}
  {{ $.Scratch.Add "chpt_countries" (dict "name" . "count" $count) }}
{{ end }}




<!-- Events -->
{{/* Fetch events data from meetup_archive JSON file and store in Scratch */}}
{{ $url := "https://raw.githubusercontent.com/rladies/meetup_archive/refs/heads/main/data/events.json" }}
{{ with try (resources.GetRemote $url) }}
  {{ with .Err }}
    {{ errorf "%s" . }}
  {{ else }}
    {{ $.Scratch.Set "events" (.Value | transform.Unmarshal) }}
  {{ end }}
{{ else }}
  {{ errorf "Unable to get remote resource %q" $url }}
{{ end }}
