{{- $url := "https://raw.githubusercontent.com/rladies/meetup_archive/refs/heads/main/data/updated.json" -}}
{{- $updated := "" -}}
{{- $events := slice -}}

{{- with try (resources.GetRemote $url) -}}
  {{- with .Err -}}
    {{- warnf "Error fetching events: %s" . -}}
  {{- else -}}
    {{- $updated = .Value | transform.Unmarshal -}}
    {{- $events = $updated.events -}}
  {{- end -}}
{{- else -}}
  {{- warnf "Unable to get remote resource %q" $url -}}
{{- end -}}

{{- $futureEvents := slice -}}
{{- $now := now.Unix -}}

{{- range $events -}}
  {{- $eventTime := time .datetime_utc -}}
  {{- if gt $eventTime.Unix $now -}}
    {{- $futureEvents = $futureEvents | append . -}}
  {{- end -}}
{{- end -}}
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//{{ .Site.Title }}//Events//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:{{ .Site.Title }} Events
X-WR-TIMEZONE:UTC
X-WR-CALDESC:Upcoming R-Ladies events worldwide
{{- range first 100 $futureEvents -}}
{{- $eventTime := time .datetime_utc -}}
{{- $endTime := $eventTime.Add (mul .duration 1000000000) -}}
{{- $now := now -}}
BEGIN:VEVENT
UID:{{ .id }}@rladies.org
DTSTAMP:{{ $now.Format "20060102T150405Z" }}
DTSTART:{{ $eventTime.Format "20060102T150405Z" }}
DTEND:{{ $endTime.Format "20060102T150405Z" }}
SUMMARY:{{ .title }} - {{ .group_name }}
DESCRIPTION:{{ .group_name }}\n{{ with .venue_name }}Location: {{ . }}\n{{ end }}{{ with .going }}{{ . }} people attending\n{{ end }}{{ with .link }}Event page: {{ . }}{{ end }}
{{- with .location }}
LOCATION:{{ . }}
{{- end }}
{{- with .link }}
URL:{{ . }}
{{- end }}
ORGANIZER;CN={{ .group_name }}:mailto:info@rladies.org
CATEGORIES:R-Ladies,{{ .group_name }}
STATUS:CONFIRMED
SEQUENCE:0
END:VEVENT
{{- end }}
END:VCALENDAR
