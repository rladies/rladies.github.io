{{ define "head" }}
  {{ $js := slice
      (resources.Get "js/fullcalendar.min.js")
      (resources.Get "js/moment.min.js")
      (resources.Get "js/moment-with-locales.min.js")
      (resources.Get "js/moment-timezone-with-data.js")
      (resources.Get "js/tooltip.min.js")
      | resources.Concat "js/events-bundle.js"
      | minify
      | fingerprint
  }}
  <script src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}" crossorigin="anonymous" defer></script>
{{ end }}

{{ define "main" }}
<div class="entry-content">{{ .Content }}</div>

{{ $url := "https://raw.githubusercontent.com/rladies/meetup_archive/refs/heads/main/data/updated.json" }}
{{ $updated := "" }}
{{ with try (resources.GetRemote $url) }}
  {{ with .Err }}
    {{ errorf "%s" . }}
  {{ else }}
    {{ $updated = .Value | transform.Unmarshal }}
  {{ end }}
{{ else }}
  {{ errorf "Unable to get remote resource %q" $url }}
{{ end }}
<center>
  <div class="row">
    <div class="col-12 border border-primary rounded bg-primary text-white ">
      <h2 class="entry-title p-2 w-100 text-white">Successfully run events</h2>
      <h4 class="my-2">{{ $updated.n_events_past }}</h4>
    </div>
  </div>
</center>
<div class="row my-4 w-100 align-items-center justify-content-between">
  <div class="col-6 col-md-4">
    <label for="time-zone-selector" class="col-form-label">Timezone</label>
  </div>
  <div class="col-12 col-md-8">
    <select id="time-zone-selector" class="form-select w-100" aria-label="Timezone">
      <option value="utc">Universal Time Coordinated (UTC)</option>
    </select>
  </div>
  <div class="float-right">
    <span id="loading">loading...</span>
  </div>
  <div style="clear: both"></div>
</div>
<div class="row">
  <div id="calendar" class="col-12">
  </div>
</div>
<small class="text-muted"></small>
{{ end }}

{{ define "footer" }}
  {{ $js := slice
      (resources.Get "js/fullcalendar.min.js")
      (resources.Get "js/moment.min.js")
      (resources.Get "js/moment-with-locales.min.js")
      (resources.Get "js/moment-timezone-with-data.js")
      (resources.Get "js/tooltip.min.js")
      | resources.Concat "js/events-bundle.js"
      | minify
      | fingerprint
  }}
  <script src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}" crossorigin="anonymous" defer></script>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    var timeZoneSelectorEl = document.getElementById("time-zone-selector");
    var loadingEl = document.getElementById("loading");
    var calendarEl = document.getElementById("calendar");
    var events = {{ $.Scratch.Get "events" }};
    var timezone_list = {{ $.Site.Data.timezones }};

    // Add local timezone option first
    var localTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    var localOption = document.createElement("option");
    localOption.id = "local";
    localOption.value = localTz;
    localOption.innerText = `Local Time Zone (${localTz})`;
    timeZoneSelectorEl.appendChild(localOption);

    // Add all other timezones
    timezone_list.forEach(function (timeZone) {
      var optionEl;

      if (timeZone !== 'UTC') { // UTC is already in the list
        optionEl = document.createElement('option');
        optionEl.value = timeZone;
        optionEl.innerText = timeZone;
        timeZoneSelectorEl.appendChild(optionEl);
      }
    });

    // Set local timezone as selected
    document.getElementById("local").selected = true;

    function getRladiesEvents(data, targetTz) {
      let updatedTime = [];
      $.each(data, function (index, ev) {
        let start = moment.utc(ev.datetime_utc).tz(targetTz);
        ev.start = start.format();
        ev.end = start.clone().add(ev.duration, 'seconds').format();
        updatedTime[index] = ev;
      });
      return updatedTime;
    }

    var calendar = new FullCalendar.Calendar(calendarEl, {
      themeSystem: 'bootstrap',
      schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
      headerToolbar: {
        left: "prev,next",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek",
      },
      initialDate: moment().format("YYYY-MM-DD"),
      titleFormat: {
        // will produce something like "Tuesday, September 18, 2018"
        month: "long",
        year: "numeric",
        day: "numeric",
      },
      initialView: "listWeek",
      height: "auto",
      dayMaxEvents: true, // allow "more" link when too many events

      eventDidMount: function (info) {
        var tooltip = new Tooltip(info.el, {
          title: info.event.extendedProps.body,
          placement: "bottom",
          trigger: "hover",
          container: "article",
          html: true
        });
      },

      events: getRladiesEvents(events, localTz),
      timeZone: 'local', // Start with local timezone

      loading: function (bool) {
        if (bool) {
          loadingEl.style.display = "inline"; // show
        } else {
          loadingEl.style.display = "none"; // hide
        }
      },

      eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false }
    });

    calendar.render();

    // On change
    timeZoneSelectorEl.addEventListener("change", function () {
      var newTimeZone = this.value;
      var eventSources = calendar.getEventSources();
      eventSources.forEach(source => source.remove());
      calendar.addEventSource(getRladiesEvents(events, newTimeZone));
      calendar.render();
    });

  });

  // add the responsive classes after page initialization
  window.onload = function () {
    $('.fc-toolbar.fc-header-toolbar').addClass('row col-xlg-12');
    $('.fc-toolbar-title').addClass('entry-title');
  };

</script>
{{ end }}
